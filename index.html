<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script defer src="assets/scripts/js/jquery-3.3.1.min.js"></script>
    <script defer src="assets/scripts/js/popper.min.js"></script>
    <script defer src="bootstrap/js/bootstrap.min.js"></script>
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <title>OpenCV.js WebAPI</title>
  </head>
  <body>
    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Spatial Filters
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a href="#" id="mean">Mean</a></li>
          <li><a href="#" id="gauss">Gauss</a></li>
          <li><a href="#" id="sobelX">Sobel X</a></li>
          <li><a href="#" id="sobelY">Sobel Y</a></li>
          <li><a href="#" id="laplacian">Laplacian</a></li>
        </ul>
    </div>
    <div class="row">
      <div class="col-md-6">
        <img id="imageSrc" alt="No Image" style="width:600px"/>
        <input type="file" id="fileInput" name="file" />
      </div>
      <div class="col-md-6">
        <canvas id="imageCanvas"></canvas>
        <a href="#" id="downloadButton">Download Image</a>
      </div>
    </div>

    <script async src="assets/scripts/js/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script type="text/javascript">
      document.body.classList.add("loading");

      function onOpenCvReady() {
        document.body.classList.remove("loading");
      }

      let imgElement = document.getElementById('imageSrc');
      let inputElement = document.getElementById('fileInput');

      inputElement.onchange = function(event) {
        imgElement.src = URL.createObjectURL(event.target.files[0]);
      };

      imgElement.onload = function() {
        let image = cv.imread(imgElement);
        cv.imshow('imageCanvas', image);
        image.delete();
      };

      document.getElementById('sobelX').onclick = function() {
        this.disabled = true;
        document.body.classList.add("loading");

        let src = cv.imread('imageSrc');
        let dstx = new cv.Mat();
        //convert to binary
        cv.cvtColor(src, src, cv.COLOR_RGB2GRAY, 0);
        cv.Sobel(src, dstx, cv.CV_8U, 1, 0, 3, 1, 0, cv.BORDER_DEFAULT);

        cv.imshow('imageCanvas', dstx);
        src.delete();
        dstx.delete();
        this.disabled = false;
        document.body.classList.remove("loading");
      };

      document.getElementById('sobelY').onclick = function() {
        this.disabled = true;
        document.body.classList.add("loading");

        let src = cv.imread('imageSrc');
        let dsty = new cv.Mat();
        //convert to binary
        cv.cvtColor(src, src, cv.COLOR_RGB2GRAY, 0);
        cv.Sobel(src, dsty, cv.CV_8U, 0, 1, 3, 1, 0, cv.BORDER_DEFAULT);

        cv.imshow('imageCanvas', dsty);
        src.delete();
        dsty.delete();
        this.disabled = false;
        document.body.classList.remove("loading");
      };

      document.getElementById('downloadButton').onclick = function() {
        this.href = document.getElementById("imageCanvas").toDataURL();
        this.download = "image.png";
      };

    </script>
    <div class="modal"></div>
  </body>
</html>
